{% extends "templates/web.html" %}
{% block title %}{{ _('H&J Fence Supply POS') }}{% endblock %}

{% block head_include %}
<link rel="stylesheet" type="text/css" href="/pos/pos.css">
<style>
    /* Inline critical styles for immediate loading */
    .pos-container {
        display: grid;
        grid-template-columns: 250px 2fr 0.8fr;
        min-height: 100vh;
        gap: 0;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }
    
    .fence-sidebar {
        background: #f8f9fa;
        border-right: 1px solid #dee2e6;
        padding: 20px 15px;
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .left-panel {
        background: white;
        display: flex;
        flex-direction: column;
        border-right: 1px solid #dee2e6;
    }
    
    .right-panel {
        background: white;
        display: flex;
        flex-direction: column;
    }
    
    .header-controls {
        display: flex;
        gap: 15px;
        align-items: center;
    }
    
    .clear-cart-btn {
        background: #dc3545;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .clear-cart-btn:hover {
        background: #c82333;
        transform: translateY(-1px);
    }
    
    .clear-cart-btn:active {
        transform: translateY(0);
    }
    
    .language-toggle {
        display: flex;
        gap: 5px;
    }
    
    .language-btn {
        background: #6c757d;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 12px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .language-btn.active {
        background: #007bff;
    }
    
    .language-btn:hover {
        background: #5a6268;
    }
    
    .language-btn.active:hover {
        background: #0056b3;
    }
    
    .cart-delete-btn:hover {
        background: #e9ecef !important;
        color: #dc3545 !important;
        border-color: #dc3545 !important;
        transform: translateY(-1px);
    }
    
    .cart-delete-btn:active {
        transform: translateY(0);
    }
</style>
{% endblock %}



{% block page_content %}
<div class="pos-container">
    <!-- Material Type Sidebar -->
    <div class="fence-sidebar">
        <!-- Popular Items Button -->
        <div class="popular-section">
            <div class="popular-btn" onclick="selectPopular()" id="popularBtn">
                <div class="popular-icon">‚òÖ</div>
                <div class="popular-name">{{ _("Popular Items") }}</div>
            </div>
        </div>
        
    
    <!-- Templates Button -->
    <div class="templates-section">
        <div class="templates-btn" onclick="selectTemplates()" id="templatesBtn">
            <div class="templates-icon">üìã</div>
            <div class="templates-name">{{ _("Templates") }}</div>
        </div>
    </div>
        
        <div class="sidebar-title">{{ _("Material Type") }}</div>
        
        {% for material in material_types %}
        <div class="fence-type-btn" data-category="{{ material.name }}" onclick="selectCategory('{{ material.name|e }}')">
            <div class="fence-type-image">
                {% if material.image %}
                    <img src="{{ material.image }}" alt="{{ material.material_type_name }}" style="width: 100%; height: 100%; object-fit: cover;" 
                         onerror="this.style.display='none'; this.parentNode.innerHTML=getCategoryFallbackIcon('{{ material.material_type_name }}');">
                {% else %}
                    {% set name_lower = material.material_type_name.lower() %}
                    {% if 'panel' in name_lower %}ü™ü
                    {% elif 'rail' in name_lower %}‚îÅ
                    {% elif 'post' in name_lower %}üìè
                    {% elif 'gate' in name_lower %}üö™
                    {% elif 'hardware' in name_lower %}üîß
                    {% elif 'cap' in name_lower %}üé©
                    {% else %}{{ material.material_type_name[:1] }}
                    {% endif %}
                {% endif %}
            </div>
            <div class="fence-type-name">{{ _(material.material_type_name) }}</div>
        </div>
        {% endfor %}
        
        <!-- No default material types - all from doctype -->
        {% if not material_types %}
        <div class="no-material-types">
            <p>No material types configured. Please add Material Types in the system.</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Main Content Panel -->
    <div class="left-panel">
        <!-- Header -->
        <div class="pos-header">
            <div class="pos-title">{{ _("H&J Fence Supply POS") }}</div>
            <div class="header-controls">
                <button class="clear-cart-btn" onclick="window.fencePOS.clearCart()" title="{{ _('Clear Cart') }}">
                    üóëÔ∏è {{ _("Clear Cart") }}
                </button>
                <div class="language-toggle">
                    <button class="language-btn active" onclick="window.fencePOS.switchLanguage('en')">EN</button>
                    <button class="language-btn" onclick="window.fencePOS.switchLanguage('es')">ES</button>
                </div>
            </div>
        </div>
        
        <!-- Customer Section -->
        <div class="customer-section">
            <div class="customer-info">
                <div class="customer-name" id="customerName">{{ _("Walk-in Customer") }}</div>
                <div class="price-list-selector">
                    <select id="priceListSelector" onchange="changePriceList(this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; background: white; font-size: 12px;">
                        <!-- Options will be populated dynamically from actual price lists -->
                    </select>
                </div>
                <div class="customer-type" id="customerType">{{ _("Individual") }}</div>
            </div>
            <div>
                <button class="customer-lookup-btn" onclick="openCustomerSearch()">{{ _("Lookup Customer") }}</button>
            </div>
        </div>
        
        <!-- Search Bar -->
        <div class="search-bar">
            <input type="text" class="search-input" placeholder="{{ _('Search fence components...') }}" id="searchInput">
        </div>
        
        <!-- Products Section -->
        <div class="items-section">
            <!-- Material Type Selection -->
            <div id="categoryView">
                <div class="section-title">{{ _("Select Material Type") }}</div>
                <div class="category-grid" id="categoryGrid">
                    <!-- Material types will be populated here -->
                </div>
            </div>
            
            <!-- Style Selection -->
            <div id="styleView" style="display: none;">
                <div class="section-title" id="styleTitle">{{ _("Select Style") }}</div>
                <div class="style-grid" id="styleGrid">
                    <!-- Styles will be populated dynamically -->
                </div>
            </div>
            
            <!-- Height, Color and Rail Type Selection -->
            <div id="optionsView" style="display: none;">
                <div class="section-title" id="optionsTitle">{{ _("Filter by Height, Color & Rail Type (Optional)") }}</div>
                <div style="margin-bottom: 15px; text-align: center; color: #666; font-size: 14px;">
                    {{ _("Leave blank to see all products, or select filters to narrow results") }}
                </div>
                <div style="margin-bottom: 25px;">
                    <div class="component-header">{{ _("Height Options") }} <button onclick="window.fencePOS.clearHeight()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">{{ _("Clear") }}</button></div>
                    <div class="option-grid" id="heightGrid">
                        <!-- Heights will be populated dynamically -->
                    </div>
                </div>
                <div style="margin-bottom: 25px;">
                    <div class="component-header">{{ _("Color Options") }} <button onclick="window.fencePOS.clearColor()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">{{ _("Clear") }}</button></div>
                    <div class="option-grid" id="colorGrid">
                        <!-- Colors will be populated dynamically -->
                    </div>
                </div>
                <div style="margin-bottom: 25px;">
                    <div class="component-header" id="railTypeHeader">{{ _("Rail Type Options") }} <button onclick="window.fencePOS.clearRailType()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">{{ _("Clear") }}</button></div>
                    <div class="option-grid" id="railTypeGrid">
                        <!-- Rail types will be populated dynamically -->
                    </div>
                </div>
                
                <!-- New Attribute Filters -->
                <div style="margin-bottom: 25px;" id="latticeTypeSection">
                    <div class="component-header">{{ _("Lattice Type Options") }} <button onclick="window.fencePOS.clearLatticeType()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">{{ _("Clear") }}</button></div>
                    <div class="option-grid" id="latticeTypeGrid">
                        <!-- Lattice types will be populated dynamically -->
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;" id="orientationSection">
                    <div class="component-header">{{ _("Orientation Options") }} <button onclick="window.fencePOS.clearOrientation()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">{{ _("Clear") }}</button></div>
                    <div class="option-grid" id="orientationGrid">
                        <!-- Orientations will be populated dynamically -->
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;" id="picketTypeSection">
                    <div class="component-header">{{ _("Picket Type Options") }} <button onclick="window.fencePOS.clearPicketType()" style="margin-left: 10px; padding: 2px 8px; font-size: 12px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">{{ _("Clear") }}</button></div>
                    <div class="option-grid" id="picketTypeGrid">
                        <!-- Picket types will be populated dynamically -->
                    </div>
                </div>

                <button class="checkout-btn" onclick="window.fencePOS.proceedToComponents()" style="width: 200px; margin: 20px auto; display: block;">
                    {{ _("Continue to Components") }}
                </button>
            </div>
            
            <!-- Component Selection -->
            <div id="componentView" style="display: none;">
                <div class="section-title" id="componentTitle">{{ _("Select Components") }}</div>
                <div id="componentsContainer">
                    <!-- Components will be loaded here -->
                </div>
            </div>
            
            <!-- Popular Items View -->
            <div id="popularView" style="display: none;">
                <div class="section-title">{{ _("Popular Items") }}</div>
                <div id="popularContent">
                    <!-- Popular items will be loaded here -->
                </div>
            </div>
            
            
            <!-- Templates View -->
            <div id="templatesView" style="display: none;">
                <div class="section-title">{{ _("Quotation Templates") }}</div>
                <div class="templates-controls">
                    <div class="template-actions">
                        <button class="btn btn-primary" onclick="showSaveTemplateModal()">
                            <i class="fa fa-save"></i> {{ _("Save Current Cart as Template") }}
                        </button>
                        <button class="btn btn-secondary" onclick="refreshTemplates()">
                            <i class="fa fa-refresh"></i> {{ _("Refresh") }}
                        </button>
                    </div>
                    <div class="template-filters">
                        <select id="templateCategoryFilter" onchange="filterTemplates()">
                            <option value="all">{{ _("All Categories") }}</option>
                            <option value="Standard Fence">{{ _("Standard Fence") }}</option>
                            <option value="Gate Package">{{ _("Gate Package") }}</option>
                            <option value="Hardware Set">{{ _("Hardware Set") }}</option>
                            <option value="Custom Package">{{ _("Custom Package") }}</option>
                            <option value="Other">{{ _("Other") }}</option>
                        </select>
                        <select id="templateCustomerTypeFilter" onchange="filterTemplates()">
                            <option value="all">{{ _("All Customer Types") }}</option>
                            <option value="Contractor">{{ _("Contractor") }}</option>
                            <option value="Homeowner">{{ _("Homeowner") }}</option>
                            <option value="Both">{{ _("Both") }}</option>
                        </select>
                        <input type="text" id="templateSearchInput" placeholder="{{ _('Search templates...') }}" onkeyup="searchTemplates()">
                    </div>
                </div>
                <div id="templatesContent" class="templates-content">
                    <!-- Template content will be loaded here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Cart Panel -->
    <div class="right-panel">
        <div class="cart-header">
            <div class="cart-title">{{ _("Item Cart") }}</div>
        </div>
        
        <div class="cart-items" id="cartItems">
            <div class="empty-cart">{{ _("No items in cart") }}</div>
        </div>
        
        <div class="cart-total">
            <div class="total-row">
                <span>{{ _("Total Quantity:") }}</span>
                <span id="totalQty">0</span>
            </div>
            <div class="total-row">
                <span>{{ _("Net Total:") }}</span>
                <span id="netTotal">$0.00</span>
            </div>
            <div class="total-row grand-total">
                <span>{{ _("Grand Total:") }}</span>
                <span id="grandTotal">$0.00</span>
            </div>
        </div>
        
        <!-- Order Options Section -->
        <div class="order-options">
            <!-- Order Type Selection -->
            <div class="option-group">
                <div class="option-label">{{ _("Order Type") }}</div>
                <div class="option-buttons">
                    <button class="option-btn selected" onclick="selectOrderType('quote')">{{ _("Quote Only") }}</button>
                    <button class="option-btn" onclick="selectOrderType('order')">{{ _("Place Order") }}</button>
                </div>
            </div>
            
            <!-- Fulfillment Method -->
            <div class="option-group" id="fulfillmentGroup" style="display: none;">
                <div class="option-label">{{ _("Fulfillment Method") }}</div>
                <div class="option-buttons">
                    <button class="option-btn" onclick="selectFulfillment('pickup')">{{ _("Pickup") }}</button>
                    <button class="option-btn" onclick="selectFulfillment('delivery')">{{ _("Delivery") }}</button>
                </div>
            </div>
            
            <!-- Shipping Options (shown only for delivery) -->
            <div class="option-group" id="shippingGroup" style="display: none;">
                <div class="option-label">{{ _("Shipping Options") }}</div>
                <div id="shippingOptionsContainer" class="shipping-options">
                    <div class="loading-shipping">{{ _("Calculating shipping rates...") }}</div>
                </div>
            </div>
            
            <!-- Schedule Options -->
            <div class="schedule-options" id="scheduleOptions">
                <div class="option-label">{{ _("Schedule") }}</div>
                <div class="schedule-buttons">
                    <button class="schedule-btn" onclick="selectSchedule('now')">{{ _("Now") }}</button>
                    <button class="schedule-btn" onclick="selectSchedule('later')">{{ _("Schedule Later") }}</button>
                </div>
                
                <!-- Calendar Container -->
                <div class="calendar-container" id="calendarContainer">
                    <div class="calendar-header">
                        <button class="calendar-nav" onclick="changeMonth(-1)">‚Äπ</button>
                        <div class="calendar-month" id="calendarMonth"></div>
                        <button class="calendar-nav" onclick="changeMonth(1)">‚Ä∫</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- Calendar will be generated here -->
                    </div>
                    <div class="time-slots" id="timeSlots" style="display: none;">
                        <div class="time-label">{{ _("Approximate Time") }}</div>
                        <div class="time-grid" id="timeGrid">
                            <!-- Time slots will be generated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Selected Schedule Display -->
                <div class="selected-schedule" id="selectedSchedule" style="display: none;">
                    <div class="selected-schedule-label">{{ _("Selected:") }}</div>
                    <div id="scheduleDisplay"></div>
                </div>
            </div>
        </div>
        
        <div class="cart-total" style="background: white; border-top: none; padding-top: 0;">
            <button class="checkout-btn" onclick="checkout()">{{ _("See Items") }}</button>
            <button class="generate-quote-btn" onclick="generateQuote()" style="display: none; margin-top: 10px; width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 6px; font-weight: 500; cursor: pointer; transition: all 0.2s ease;">
                {{ _("Generate Quote") }}
            </button>
        </div>
    </div>
</div>

<!-- Customer Search Modal -->
<div class="customer-search-overlay" id="customerSearchOverlay">
    <div class="customer-search-modal">
        <div class="customer-search-header">{{ _("Select Customer") }}</div>
        <input type="text" class="customer-search-input" id="customerSearchInput" placeholder="{{ _('Search by name, phone, or email...') }}">
        <div class="customer-list" id="customerList">
            <!-- Customer list will be populated here -->
        </div>
        <div class="customer-search-actions">
            <button class="customer-search-cancel" onclick="closeCustomerSearch()">{{ _("Cancel") }}</button>
        </div>
    </div>
</div>
{% endblock %}

<!-- Save Template Modal -->
<div id="saveTemplateModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>{{ _("Save Cart as Template") }}</h3>
            <span class="close" onclick="closeSaveTemplateModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="saveTemplateForm">
                <div class="form-group">
                    <label for="templateName">{{ _("Template Name") }} *</label>
                    <input type="text" id="templateName" name="templateName" required placeholder="{{ _('Enter template name...') }}">
                </div>
                <div class="form-group">
                    <label for="templateDescription">{{ _("Description") }}</label>
                    <textarea id="templateDescription" name="templateDescription" rows="3" placeholder="{{ _('Enter template description...') }}"></textarea>
                </div>
                <div class="form-group">
                    <label for="templateCategory">{{ _("Category") }}</label>
                    <select id="templateCategory" name="templateCategory">
                        <option value="Standard Fence">{{ _("Standard Fence") }}</option>
                        <option value="Gate Package">{{ _("Gate Package") }}</option>
                        <option value="Hardware Set">{{ _("Hardware Set") }}</option>
                        <option value="Custom Package">{{ _("Custom Package") }}</option>
                        <option value="Other">{{ _("Other") }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="templateCustomerType">{{ _("Customer Type") }}</label>
                    <select id="templateCustomerType" name="templateCustomerType">
                        <option value="Both">{{ _("Both") }}</option>
                        <option value="Contractor">{{ _("Contractor") }}</option>
                        <option value="Homeowner">{{ _("Homeowner") }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="templatePriceList">{{ _("Default Price List") }}</label>
                    <select id="templatePriceList" name="templatePriceList">
                        <option value="">{{ _("Use Current Price List") }}</option>
                        <option value="Contractor">{{ _("Contractor") }}</option>
                        <option value="Homeowner">{{ _("Homeowner") }}</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="templateNotes">{{ _("Template Notes") }}</label>
                    <textarea id="templateNotes" name="templateNotes" rows="2" placeholder="{{ _('Additional notes for this template...') }}"></textarea>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn btn-secondary" onclick="closeSaveTemplateModal()">{{ _("Cancel") }}</button>
            <button type="button" class="btn btn-primary" onclick="saveTemplate()">{{ _("Save Template") }}</button>
        </div>
    </div>
</div>

{% block script %}
<script>
// Fallback icon function for category buttons
function getCategoryFallbackIcon(materialTypeName) {
    const nameLower = materialTypeName.toLowerCase();
    if (nameLower.includes('panel')) return 'ü™ü';
    if (nameLower.includes('rail')) return '‚îÅ';
    if (nameLower.includes('post')) return 'üìè';
    if (nameLower.includes('gate')) return 'üö™';
    if (nameLower.includes('hardware')) return 'üîß';
    if (nameLower.includes('cap')) return 'üé©';
    return materialTypeName.charAt(0);
}
</script>
<script type="text/javascript" src="/pos/index.js"></script>
{% endblock %} 